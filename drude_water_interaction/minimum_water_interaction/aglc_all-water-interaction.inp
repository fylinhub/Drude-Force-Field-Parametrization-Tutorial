* Water interactions
* 

ioformat extended

!### Things that should be reconsidered for every molecule ###
set residue aglc
set bombover 0 !needs to be set to -1 for 3-membered rings

set stage 5 !4=do everything with mp2 geometry for h2o inter
            !5=do everything with charmm geometry for h2o inter

set NoDrude false

!### Things that usually shouldn't be changed. ####
set dontmini 0 ! Don't minimize main conformation. Should normally not be used.

!non-bond parameters
set 3 999.0  ! cutim
set 4 999.0  ! cutnb
set 5 980.0  ! ctonnb
set 6 990.0  ! ctofnb
set 7 switch
set 8 atom
set 9 vatom

!stream in files
set quickdir ../..
set TOPPAR ../../toppar_drude

if NoDrude .eq. true then
   open unit 10 read card name @TOPPAR/top_all36_carb.rtf
   read rtf card unit 10
   close unit 10
   open unit 10 read card name @TOPPAR/par_all36_carb.prm
   read para card unit 10
   close unit 10
else
   stream @TOPPAR/toppar_drude_master_protein_2013c_oct09.str
   stream @TOPPAR/toppar_drude_carbohydrate_2013c_nov11.str
endif

!SINCE inter is not correctly implemented for drude ff, the interaction should be computed:
!interaction = E_mol_wat - E_wat - E_mol
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!compute the energy of water firstly: in fact, the energy for swm4 is 0.00
read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

ic seed swm4 1 h1 swm4 1 oh2 swm4 1 h2
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cdie inbfrq -1 ihbfrq 0 -
@7 @8 @9 vswitch cutnb @4 ctofnb @6 ctonnb @5

cons harm force 1000.0 sele .not. type D* show end
cons harm force 1000.0 sele type dum show end
MINI SD nstep 200 tolgrd 0.00001
MINI ABNR nstep 500 tolgrd 0.00001
cons harm force 0.0 sele all end
coor print

energy

set wele ?elec
set wvdw ?vdw
set wener ?ener
write coor pdb name swm4.pdb

delete atom select all end
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!read sequence @residue 1
read sequence card
* @residue
*
1
@residue

bomlev @bombover
if NoDrude .eq. true then
   generate  @residue first none last none setup warn !drude dmass 0.4
else
   generate  @residue first none last none setup warn drude dmass 0.4
endif
bomlev 0

!read coor card name @residue_mp2.crd
open read card unit 21 name @residue_mp2.crd
read coor card unit 21

if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor copy comp
coor print ! use to make sure parent coords are not modified

update cdie inbfrq -1 ihbfrq 0 -
@7 @8 @9 vswitch cutnb @4 ctofnb @6 ctonnb @5

if @stage eq 4 then
  open unit 50 write form name @residue_water_constr.ene
else
  if @dontmini eq 0 then
    ! minimize Drude coordinates
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end

    coor print
    open unit 21 write form name @residue_min.crd
    write coor card unit 21 sele .not. ( type D* .or. type LP* ) end
    open unit 22 write form name @residue_min.pdb
    write coor pdb  unit 22

  endif
  if @stage ne 5 stop

  ! align charmm optimized structure ito mp2 in order to allow
  ! for the components of the dipole moment to be checked.
  coor orient rms
  coor orient mass noro
  coor print
  write coor pdb name @residue_min_orient.pdb

  open unit 50 write form name @residue_water.ene
endif

!compute the energy for the molecule only
energy

set mele ?elec
set mvdw ?vdw
set mener ?ener

!water interactions: variables for averages etc.
set count 0
set asum 0.0
set sum 0.0
set sum2 0.0

coor dipole oxyz select segid @residue end
echu 50
echo @residue water interaction
if @stage eq 4 echo ######## USING MP2 GEOMETRY!!! ########
echo QM dipole (Debye)
echo mp2/6-31g*:    X=    x.xxxx    Y=    x.xxxx    Z=    x.xxxx  Tot=     x.xxxx
echo hf/6-31g*:    X=     x.xxxx    Y=    x.xxxx    Z=    x.xxxx  Tot=     x.xxxx
echo empirical dipole: ?xdip ?ydip ?zdip ?rdip

ic delete sele all end

coor copy comp
!!! ***** BEGIN of water interactions ***** !!!

!1) C6H...OHH  90.0 degrees

set d 1.60 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
2
dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit
dihe 1 H62   1 C6   1 H61   3 dum   0.0
dihe 1 C6   1 H61   3 dum  4 dum   0.0
dihe 4 dum  3 dum  1 H61   2 oh2 180.0
end
ic fill preserve
ic edit
dihe 3 dum  1 H61   2 oh2  2 h1   90.0
dihe 3 dum  1 H61   2 oh2  2 h2  -90.0
bond 1 H61   3 dum  1.
bond 3 dum  4 dum  1.
bond 1 H61   2 oh2  @d !varied
bond 2 oh2  2 h1   0.9572
bond 2 oh2  2 h2   0.9572
angl 1 C6   1 H61   3 dum  90.0
angl 1 H61   3 dum  4 dum  90.0
angl 3 dum  1 H61   2 oh2  90.0
angl 1 H61   2 oh2  2 h1  127.74
angl 1 H61   2 oh2  2 h2  127.74
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_1

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_1
set u @m

incr d by 0.01
ic edit
bond 2 oh2   1 H61   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_1
label done_1
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat1.pdb 
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai  -1.0696673774    !  
set aidist 2.46
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 1) C6H..OHH  90.0 degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!2) C6H...OHH  90.0 degrees

set d 1.60 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
2
dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit
dihe 1 H61   1 C6   1 H62   3 dum   0.0
dihe 1 C6   1 H62   3 dum  4 dum   0.0
dihe 4 dum  3 dum  1 H62   2 oh2 180.0
end
ic fill preserve
ic edit
dihe 3 dum  1 H62   2 oh2  2 h1   90.0
dihe 3 dum  1 H62   2 oh2  2 h2  -90.0
bond 1 H62   3 dum  1.
bond 3 dum  4 dum  1.
bond 1 H62   2 oh2  @d !varied
bond 2 oh2  2 h1   0.9572
bond 2 oh2  2 h2   0.9572
angl 1 C6   1 H62   3 dum  90.0
angl 1 H62   3 dum  4 dum  90.0
angl 3 dum  1 H62   2 oh2  90.0
angl 1 H62   2 oh2  2 h1  127.74
angl 1 H62   2 oh2  2 h2  127.74
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_2

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_2
set u @m

incr d by 0.01
ic edit
bond 2 oh2   1 H62   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_2
label done_2
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat2.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -0.6890483982      
set aidist 2.47
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 2) C6H..OHH  90.0 degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!3) O5....HOH lone pair, hoh:   0. degrees

set d 1.60 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
3
dum dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit


dihe 2 h1   1 O5   1 C5   1 C1    121.142
dihe 1 C1   1 C5   1 O5   3 dum -90.0
dihe 3 dum  1 O5   2 h1   4 dum   0.0
dihe 1 O5   2 h1   4 dum  5 dum   0.0
dihe 5 dum  4 dum  2 h1   2 oh2 180.0
dihe 2 h2   2 oh2  2 h1   4 dum    0.
end
ic fill preserve
ic edit
bond 2 h1   1 O5   @d !varied
bond 1 O5   3 dum  1.
bond 2 h1   4 dum  1.
bond 4 dum  5 dum  1.
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O5   1 C5   108.509
angl 1 C5   1 O5   3 dum  90.0
angl 1 O5   2 h1   4 dum  90.0
angl 2 h1   4 dum  5 dum  90.0
angl 4 dum  2 h1   2 oh2  90.0
angl 2 h2   2 oh2  2 h1   104.52 
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_3

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_3
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O5   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_3
label done_3
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat3.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -4.7722816311      
set aidist 1.91
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 3) O5...HOH lone pair, hoh:   0. degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!4) O5....HOH  90. degrees

set d 1.60 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
1
dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!obtain the inner angle.
quick 1 10 7 !$MOD
!calculate the outer angle
calc oangle = ( 360.0 - ?thet ) / 2.

! preparation of IC table for surface of interest

ic edit
dihe 2 h1   1 O5   1 C5   1 C1   180.
dihe 3 dum  2 h1   1 O5   1 C5     0.0
dihe 2 oh2  2 h1   3 dum  1 O5   180.0
dihe 2 h2   2 oh2  2 h1   3 dum   90.
!
bond 2 h1   1 O5   @d
bond 3 dum  2 h1   1.0
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O5   1 C5   @oangle
angl 3 dum  2 h1   1 O5    90.0
angl 2 oh2  2 h1   3 dum   90.0  
angl 2 h2   2 oh2  2 h1   104.52 
end

ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_4

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_4
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O5   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_4
label done_4
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat4.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics from each water calculation
calc count = @count + 1 
set ai -4.0865237541   ! 
set aidist 1.96
calc diff = @m - @ai  
calc sum = @sum + @diff  
calc diff2 = abs(@diff*@diff)  
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist 

! write ab initio and empirical information to unit 50 
echo 4) O5...HOH,  90. degrees
echo a.i. @ai @aidist 
echo emp. @m @o @x @n  
echo ene diff: @diff dist diff: @distdiff 

delet atom sele resn SWM4 .or. resn dum end

!5) O6H...OHH  90.0 degrees

set d 4.00 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
2
dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit
dihe 1 C6   1 O6   1 HO6   3 dum   0.0
dihe 1 O6   1 HO6   3 dum  4 dum   0.0
dihe 4 dum  3 dum  1 HO6   2 oh2 180.0
end
ic fill preserve
ic edit
dihe 3 dum  1 HO6   2 oh2  2 h1   90.0
dihe 3 dum  1 HO6   2 oh2  2 h2  -90.0
bond 1 HO6   3 dum  1.
bond 3 dum  4 dum  1.
bond 1 HO6   2 oh2  @d !varied
bond 2 oh2  2 h1   0.9572
bond 2 oh2  2 h2   0.9572
angl 1 O6   1 HO6   3 dum  90.0
angl 1 HO6   3 dum  4 dum  90.0
angl 3 dum  1 HO6   2 oh2  90.0
angl 1 HO6   2 oh2  2 h1  127.74
angl 1 HO6   2 oh2  2 h2  127.74
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_5

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_5
set u @m

incr d by 0.01
ic edit
bond 2 oh2   1 HO6   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_5
label done_5
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat5.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -2.3742407534   !  
set aidist 4.07
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 5) O6H..OHH  90.0 degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!6) O1H...OHH  90.0 degrees

set d 1.75 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
2
dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit
dihe 1 C1   1 O1   1 HO1   3 dum   0.0
dihe 1 O1   1 HO1   3 dum  4 dum   0.0
dihe 4 dum  3 dum  1 HO1   2 oh2 180.0
end
ic fill preserve
ic edit
dihe 3 dum  1 HO1   2 oh2  2 h1   90.0
dihe 3 dum  1 HO1   2 oh2  2 h2  -90.0
bond 1 HO1   3 dum  1.
bond 3 dum  4 dum  1.
bond 1 HO1   2 oh2  @d !varied
bond 2 oh2  2 h1   0.9572
bond 2 oh2  2 h2   0.9572
angl 1 O1   1 HO1   3 dum  90.0
angl 1 HO1   3 dum  4 dum  90.0
angl 3 dum  1 HO1   2 oh2  90.0
angl 1 HO1   2 oh2  2 h1  127.74
angl 1 HO1   2 oh2  2 h2  127.74
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_6

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_6
set u @m

incr d by 0.01
ic edit
bond 2 oh2   1 HO1   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_6
label done_6
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat6.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -6.8311669369    ! 
set aidist 1.84
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 6) O1H..OHH  90.0 degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!7) O2H...OHH  90.0 degrees

set d 3.50 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
2
dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit
dihe 1 C2   1 O2   1 HO2   3 dum   0.0
dihe 1 O2   1 HO2   3 dum  4 dum   0.0
dihe 4 dum  3 dum  1 HO2   2 oh2 180.0
end
ic fill preserve
ic edit
dihe 3 dum  1 HO2   2 oh2  2 h1   90.0
dihe 3 dum  1 HO2   2 oh2  2 h2  -90.0
bond 1 HO2   3 dum  1.
bond 3 dum  4 dum  1.
bond 1 HO2   2 oh2  @d !varied
bond 2 oh2  2 h1   0.9572
bond 2 oh2  2 h2   0.9572
angl 1 O2   1 HO2   3 dum  90.0
angl 1 HO2   3 dum  4 dum  90.0
angl 3 dum  1 HO2   2 oh2  90.0
angl 1 HO2   2 oh2  2 h1  127.74
angl 1 HO2   2 oh2  2 h2  127.74
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_7

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_7
set u @m

incr d by 0.01
ic edit
bond 2 oh2   1 HO2   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_7
label done_7
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat7.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -0.3657127141   
set aidist 3.13
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 7) O2H..OHH  90.0 degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!8) O3H...OHH  90.0 degrees

set d 2.50 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
2
dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit
dihe 1 C3   1 O3   1 HO3   3 dum   0.0
dihe 1 O3   1 HO3   3 dum  4 dum   0.0
dihe 4 dum  3 dum  1 HO3   2 oh2 180.0
end
ic fill preserve
ic edit
dihe 3 dum  1 HO3   2 oh2  2 h1   90.0
dihe 3 dum  1 HO3   2 oh2  2 h2  -90.0
bond 1 HO3   3 dum  1.
bond 3 dum  4 dum  1.
bond 1 HO3   2 oh2  @d !varied
bond 2 oh2  2 h1   0.9572
bond 2 oh2  2 h2   0.9572
angl 1 O3   1 HO3   3 dum  90.0
angl 1 HO3   3 dum  4 dum  90.0
angl 3 dum  1 HO3   2 oh2  90.0
angl 1 HO3   2 oh2  2 h1  127.74
angl 1 HO3   2 oh2  2 h2  127.74
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_8

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_8
set u @m

incr d by 0.01
ic edit
bond 2 oh2   1 HO3   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_8
label done_8
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat8.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -1.2845538059    
set aidist 2.08
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 8) O3H..OHH  90.0 degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!9) O4H...OHH  90.0 degrees

set d 1.85 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
2
dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit
dihe 1 C4   1 O4   1 HO4   3 dum   0.0
dihe 1 O4   1 HO4   3 dum  4 dum   0.0
dihe 4 dum  3 dum  1 HO4   2 oh2 180.0
end
ic fill preserve
ic edit
dihe 3 dum  1 HO4   2 oh2  2 h1   90.0
dihe 3 dum  1 HO4   2 oh2  2 h2  -90.0
bond 1 HO4   3 dum  1.
bond 3 dum  4 dum  1.
bond 1 HO4   2 oh2  @d !varied
bond 2 oh2  2 h1   0.9572
bond 2 oh2  2 h2   0.9572
angl 1 O4   1 HO4   3 dum  90.0
angl 1 HO4   3 dum  4 dum  90.0
angl 3 dum  1 HO4   2 oh2  90.0
angl 1 HO4   2 oh2  2 h1  127.74
angl 1 HO4   2 oh2  2 h2  127.74
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_9

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_9
set u @m

incr d by 0.01
ic edit
bond 2 oh2   1 HO4   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_9
label done_9
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat9.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai 0.0497214892    !  
set aidist 2.42
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 9) O4H..OHH  90.0 degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!10) O6....HOH lone pair, hoh: 180. degrees

set d 1.92 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
3
dum dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit


dihe 2 h1   1 O6   1 C6   1 HO6   -119.210
dihe 1 HO6   1 C6   1 O6   3 dum -90.0
dihe 3 dum  1 O6   2 h1   4 dum   0.0
dihe 1 O6   2 h1   4 dum  5 dum   0.0
dihe 5 dum  4 dum  2 h1   2 oh2 180.0
dihe 2 h2   2 oh2  2 h1   4 dum  180.
end
ic fill preserve
ic edit
bond 2 h1   1 O6   @d !varied
bond 1 O6   3 dum  1.
bond 2 h1   4 dum  1.
bond 4 dum  5 dum  1.
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O6   1 C6   110.102
angl 1 C6   1 O6   3 dum  90.0
angl 1 O6   2 h1   4 dum  90.0
angl 2 h1   4 dum  5 dum  90.0
angl 4 dum  2 h1   2 oh2  90.0
angl 2 h2   2 oh2  2 h1   104.52 
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_10

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_10
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O6   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_10
label done_10
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat10.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -6.1200237900    !   
set aidist 1.92
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 10) O6...HOH lone pair, hoh: 180. degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!11) O6....HOH 270. degrees

set d 1.95 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
1
dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!obtain the inner angle.
quick 41 45 47 !$MOD
!calculate the outer angle
calc oangle = ( 360.0 - ?thet ) / 2.

! preparation of IC table for surface of interest

ic edit
dihe 2 h1   1 O6   1 C6   1 HO6   180.
dihe 3 dum  2 h1   1 O6   1 C6     0.0
dihe 2 oh2  2 h1   3 dum  1 O6   180.0
dihe 2 h2   2 oh2  2 h1   3 dum  270.
!
bond 2 h1   1 O6   @d
bond 3 dum  2 h1   1.0
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O6   1 C6   @oangle
angl 3 dum  2 h1   1 O6    90.0
angl 2 oh2  2 h1   3 dum   90.0  
angl 2 h2   2 oh2  2 h1   104.52 
end

ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_11

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_11
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O6   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_11
label done_11
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat11.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics from each water calculation
calc count = @count + 1 
set ai -5.3542111563    !   
set aidist 1.95
calc diff = @m - @ai  
calc sum = @sum + @diff  
calc diff2 = abs(@diff*@diff)  
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist 

! write ab initio and empirical information to unit 50 
echo 11) O6...HOH, 270. degrees
echo a.i. @ai @aidist 
echo emp. @m @o @x @n  
echo ene diff: @diff dist diff: @distdiff 

delet atom sele resn SWM4 .or. resn dum end

!12) O1....HOH lone pair, hoh: 180. degrees (this interaction was shut because I cannot get the converged g03 calculations)

!!set d 5.5 ! initial interaction distance

!!read sequence card
!!* water
!!*
!!1
!!SWM4

!!generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

!!join @residue SWM4 renumber

!!read sequence card
!!* dummy
!!*
!!3
!!dum dum dum

!!generate dum first none last none setup warn noangle nodihedral

!!join @residue dum renumber

!preparation of IC table for surface of interest

!!ic edit


!!dihe 2 h1   1 O1   1 C1   1 HO1   -119.558
!!dihe 1 HO1   1 C1   1 O1   3 dum -90.0
!!dihe 3 dum  1 O1   2 h1   4 dum   0.0
!!dihe 1 O1   2 h1   4 dum  5 dum   0.0
!!dihe 5 dum  4 dum  2 h1   2 oh2 180.0
!!dihe 2 h2   2 oh2  2 h1   4 dum  180.
!!end
!!ic fill preserve
!!ic edit
!!bond 2 h1   1 O1   @d !varied
!!bond 1 O1   3 dum  1.
!!bond 2 h1   4 dum  1.
!!bond 4 dum  5 dum  1.
!!bond 2 oh2  2 h1   0.9572
!!bond 2 h2   2 oh2  0.9572 
!!angl 2 h1   1 O1   1 C1   109.828
!!angl 1 C1   1 O1   3 dum  90.0
!!angl 1 O1   2 h1   4 dum  90.0
!!angl 2 h1   4 dum  5 dum  90.0
!!angl 4 dum  2 h1   2 oh2  90.0
!!angl 2 h2   2 oh2  2 h1   104.52 
!!end


!!ic print
!!ic build
!!if NoDrude .eq. false then
!!   coor sdrude
!!   coor shake
!!endif
!!coor print

!!update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100

!!set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

!!label loop_12

!!inter -
!!   sele segid @residue end -
!!   sele resn SWM4 end

!check for lowest energy and store data
!!set n @d
!!set o ?elec
!!set x ?vdw
!!set m ?ener

!!if @u lt @m goto done_12
!!set u @m

!!ic edit
!!bond 2 h1  1 O1   @d
!!end

!initialize water coordinates
!!coor init sele resn SWM4 .or. resn dum end

!!ic build
!!if NoDrude .eq. false then
!!   coor sdrude
!!   coor shake
!!endif

!!    cons harm force 10000000.0 sele .not. type D* show end
!!    cons harm force 10000000.0 sele type dum show end
!!    MINI SD nstep 200 tolgrd 0.00001
!!    MINI ABNR nstep 500 tolgrd 0.00001
!!    cons harm force 0.0 sele all end
!!    coor print

!!prnlev -5

!!incr d by 0.01

!!if @d lt 6.5 goto loop_12
!!label done_12

!!prnlev 5

!!delete atom sele type dum end

!!open unit 30 write form name @residue_wat12.pdb
!!write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
!!* @residue
!!*

!accumulate statistics   
!!calc count = @count + 1  
!!set ai -0.22    !   
!!set aidist 5.99
!!calc diff = @m - @ai 
!!calc sum = @sum + @diff 
!!calc diff2 = abs(@diff*@diff) 
!!calc sum2 = @sum2 + @diff2  
!!calc asum = @asum + abs(@diff)  

!!calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
!!echo 12) O1...HOH lone pair, hoh: 180. degrees
!!echo a.i. @ai @aidist
!!echo emp. @m @o @x @n
!!echo ene diff: @diff dist diff: @distdiff

!!delet atom sele resn SWM4 .or. resn dum end

!13) O1....HOH  90. degrees

set d 2.50 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
1
dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!obtain the inner angle.
quick 1 4 6 !$MOD
!calculate the outer angle
calc oangle = ( 360.0 - ?thet ) / 2.

! preparation of IC table for surface of interest

ic edit
dihe 2 h1   1 O1   1 C1   1 HO1   180.
dihe 3 dum  2 h1   1 O1   1 C1     0.0
dihe 2 oh2  2 h1   3 dum  1 O1   180.0
dihe 2 h2   2 oh2  2 h1   3 dum   90.
!
bond 2 h1   1 O1   @d
bond 3 dum  2 h1   1.0
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O1   1 C1   @oangle
angl 3 dum  2 h1   1 O1    90.0
angl 2 oh2  2 h1   3 dum   90.0  
angl 2 h2   2 oh2  2 h1   104.52 
end

ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_13

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_13
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O1   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_13
label done_13
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat13.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics from each water calculation
calc count = @count + 1 
set ai -1.6739625275    ! 
set aidist 2.04
calc diff = @m - @ai  
calc sum = @sum + @diff  
calc diff2 = abs(@diff*@diff)  
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist 

! write ab initio and empirical information to unit 50 
echo 13) O1...HOH,  90. degrees
echo a.i. @ai @aidist 
echo emp. @m @o @x @n  
echo ene diff: @diff dist diff: @distdiff 

delet atom sele resn SWM4 .or. resn dum end

!14) O2....HOH lone pair, hoh:   0. degrees

set d 1.90 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
3
dum dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit


dihe 2 h1   1 O2   1 C2   1 HO2    118.909
dihe 1 HO2   1 C2   1 O2   3 dum -90.0
dihe 3 dum  1 O2   2 h1   4 dum   0.0
dihe 1 O2   2 h1   4 dum  5 dum   0.0
dihe 5 dum  4 dum  2 h1   2 oh2 180.0
dihe 2 h2   2 oh2  2 h1   4 dum    0.
end
ic fill preserve
ic edit
bond 2 h1   1 O2   @d !varied
bond 1 O2   3 dum  1.
bond 2 h1   4 dum  1.
bond 4 dum  5 dum  1.
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O2   1 C2   110.336
angl 1 C2   1 O2   3 dum  90.0
angl 1 O2   2 h1   4 dum  90.0
angl 2 h1   4 dum  5 dum  90.0
angl 4 dum  2 h1   2 oh2  90.0
angl 2 h2   2 oh2  2 h1   104.52 
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_14

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_14
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O2   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_14
label done_14
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat14.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -4.6593431518    !   
set aidist 1.95
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 14) O2...HOH lone pair, hoh:   0. degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!15) O2....HOH 270. degrees

set d 1.90 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
1
dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!obtain the inner angle.
quick 17 20 22 !$MOD
!calculate the outer angle
calc oangle = ( 360.0 - ?thet ) / 2.

! preparation of IC table for surface of interest

ic edit
dihe 2 h1   1 O2   1 C2   1 HO2   180.
dihe 3 dum  2 h1   1 O2   1 C2     0.0
dihe 2 oh2  2 h1   3 dum  1 O2   180.0
dihe 2 h2   2 oh2  2 h1   3 dum  270.
!
bond 2 h1   1 O2   @d
bond 3 dum  2 h1   1.0
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O2   1 C2   @oangle
angl 3 dum  2 h1   1 O2    90.0
angl 2 oh2  2 h1   3 dum   90.0  
angl 2 h2   2 oh2  2 h1   104.52 
end

ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_15

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_15
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O2   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_15
label done_15
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat15.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics from each water calculation
calc count = @count + 1 
set ai -4.2015511254    ! 
set aidist 1.97
calc diff = @m - @ai  
calc sum = @sum + @diff  
calc diff2 = abs(@diff*@diff)  
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist 

! write ab initio and empirical information to unit 50 
echo 15) O2...HOH, 270. degrees
echo a.i. @ai @aidist 
echo emp. @m @o @x @n  
echo ene diff: @diff dist diff: @distdiff 

delet atom sele resn SWM4 .or. resn dum end

!16) O3....HOH lone pair, hoh:   0. degrees

set d 1.95 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
3
dum dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit


dihe 2 h1   1 O3   1 C3   1 HO3    119.106
dihe 1 HO3   1 C3   1 O3   3 dum -90.0
dihe 3 dum  1 O3   2 h1   4 dum   0.0
dihe 1 O3   2 h1   4 dum  5 dum   0.0
dihe 5 dum  4 dum  2 h1   2 oh2 180.0
dihe 2 h2   2 oh2  2 h1   4 dum    0.
end
ic fill preserve
ic edit
bond 2 h1   1 O3   @d !varied
bond 1 O3   3 dum  1.
bond 2 h1   4 dum  1.
bond 4 dum  5 dum  1.
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O3   1 C3   110.183
angl 1 C3   1 O3   3 dum  90.0
angl 1 O3   2 h1   4 dum  90.0
angl 2 h1   4 dum  5 dum  90.0
angl 4 dum  2 h1   2 oh2  90.0
angl 2 h2   2 oh2  2 h1   104.52 
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_16

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_16
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O3   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_16
label done_16
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat16.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -4.4145928406    !  
set aidist 1.95
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 16) O3...HOH lone pair, hoh:   0. degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!17) O3....HOH 270. degrees

set d 1.90 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
1
dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!obtain the inner angle.
quick 25 28 30 !$MOD
!calculate the outer angle
calc oangle = ( 360.0 - ?thet ) / 2.

! preparation of IC table for surface of interest

ic edit
dihe 2 h1   1 O3   1 C3   1 HO3   180.
dihe 3 dum  2 h1   1 O3   1 C3     0.0
dihe 2 oh2  2 h1   3 dum  1 O3   180.0
dihe 2 h2   2 oh2  2 h1   3 dum  270.
!
bond 2 h1   1 O3   @d
bond 3 dum  2 h1   1.0
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O3   1 C3   @oangle
angl 3 dum  2 h1   1 O3    90.0
angl 2 oh2  2 h1   3 dum   90.0  
angl 2 h2   2 oh2  2 h1   104.52 
end

ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_17

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_17
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O3   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_17
label done_17
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat17.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics from each water calculation
calc count = @count + 1 
set ai -4.0947288864    ! 
set aidist 1.87
calc diff = @m - @ai  
calc sum = @sum + @diff  
calc diff2 = abs(@diff*@diff)  
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist 

! write ab initio and empirical information to unit 50 
echo 17) O3...HOH, 270. degrees
echo a.i. @ai @aidist 
echo emp. @m @o @x @n  
echo ene diff: @diff dist diff: @distdiff 

delet atom sele resn SWM4 .or. resn dum end

!18) O4....HOH lone pair, hoh: 180. degrees

set d 1.97 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
3
dum dum dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!preparation of IC table for surface of interest

ic edit


dihe 2 h1   1 O4   1 C4   1 HO4   -119.085
dihe 1 HO4   1 C4   1 O4   3 dum -90.0
dihe 3 dum  1 O4   2 h1   4 dum   0.0
dihe 1 O4   2 h1   4 dum  5 dum   0.0
dihe 5 dum  4 dum  2 h1   2 oh2 180.0
dihe 2 h2   2 oh2  2 h1   4 dum  180.
end
ic fill preserve
ic edit
bond 2 h1   1 O4   @d !varied
bond 1 O4   3 dum  1.
bond 2 h1   4 dum  1.
bond 4 dum  5 dum  1.
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O4   1 C4   110.199
angl 1 C4   1 O4   3 dum  90.0
angl 1 O4   2 h1   4 dum  90.0
angl 2 h1   4 dum  5 dum  90.0
angl 4 dum  2 h1   2 oh2  90.0
angl 2 h2   2 oh2  2 h1   104.52 
end


ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_18

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_18
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O4   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_18
label done_18
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat18.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics   
calc count = @count + 1  
set ai -4.6286723508    !   
set aidist 1.97
calc diff = @m - @ai 
calc sum = @sum + @diff 
calc diff2 = abs(@diff*@diff) 
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist  

! write ab initio and empirical information to unit 50
echo 18) O4...HOH lone pair, hoh: 180. degrees
echo a.i. @ai @aidist
echo emp. @m @o @x @n
echo ene diff: @diff dist diff: @distdiff

delet atom sele resn SWM4 .or. resn dum end

!19) O4....HOH 270. degrees

set d 1.85 ! initial interaction distance
coor copy

read sequence card
* water
*
1
SWM4

generate SWM4 first none last none setup warn noangle nodihedral drude dmass 0.4

join @residue SWM4 renumber

read sequence card
* dummy
*
1
dum

generate dum first none last none setup warn noangle nodihedral

join @residue dum renumber

!obtain the inner angle.
quick 33 36 38 !$MOD
!calculate the outer angle
calc oangle = ( 360.0 - ?thet ) / 2.

! preparation of IC table for surface of interest

ic edit
dihe 2 h1   1 O4   1 C4   1 HO4   180.
dihe 3 dum  2 h1   1 O4   1 C4     0.0
dihe 2 oh2  2 h1   3 dum  1 O4   180.0
dihe 2 h2   2 oh2  2 h1   3 dum  270.
!
bond 2 h1   1 O4   @d
bond 3 dum  2 h1   1.0
bond 2 oh2  2 h1   0.9572
bond 2 h2   2 oh2  0.9572 
angl 2 h1   1 O4   1 C4   @oangle
angl 3 dum  2 h1   1 O4    90.0
angl 2 oh2  2 h1   3 dum   90.0  
angl 2 h2   2 oh2  2 h1   104.52 
end

ic print
ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif
coor print

update cutnb 999.0 ctofnb 998.0 ctonnb 997.0 switch vswitch inbfrq 100
    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

set u 1000. ! minimum energy

!output file for water distance optimization
!open unit 99 write format name @residue_water_charmm.surf

label loop_19

energy
set cele ?elec
set cvdw ?vdw
set cener ?ener

calc eo = @cele - @mele - @wele
calc ex = @cvdw - @mvdw - @wvdw
calc em = @cener - @mener - @wener

!check for lowest energy and store data
set n @d
!set o ?elec
!set x ?vdw
!set m ?ener
set o @eo
set x @ex
set m @em

if @u lt @m goto done_19
set u @m

incr d by 0.01
ic edit
bond 2 h1  1 O4   @d
end

!initialize water coordinates
coor init sele resn SWM4 .or. resn dum end

ic build
if NoDrude .eq. false then
   coor sdrude
   coor shake
endif

    cons harm force 10000000.0 sele .not. type D* show end
    cons harm force 10000000.0 sele type dum show end
    MINI SD nstep 200 tolgrd 0.00001
    MINI ABNR nstep 500 tolgrd 0.00001
    cons harm force 0.0 sele all end
    coor print

prnlev -5


if @d lt 4.5 goto loop_19
label done_19
decr d by 0.01

prnlev 5

delete atom sele type dum end

open unit 30 write form name @residue_wat19.pdb
write coor pdb unit 30 sele .not. ( type D* .or. type LP* .or. type OM) end
* @residue
*

!accumulate statistics from each water calculation
calc count = @count + 1 
set ai -1.0984796115    !  
set aidist 4.06
calc diff = @m - @ai  
calc sum = @sum + @diff  
calc diff2 = abs(@diff*@diff)  
calc sum2 = @sum2 + @diff2  
calc asum = @asum + abs(@diff)  

calc distdiff = @n - @aidist 

! write ab initio and empirical information to unit 50 
echo 19) O4...HOH, 270. degrees
echo a.i. @ai @aidist 
echo emp. @m @o @x @n  
echo ene diff: @diff dist diff: @distdiff 

delet atom sele resn SWM4 .or. resn dum end


!calculate statistics from all water calculations
!average difference
calc avediff = @sum/@count
calc avediff2 = @sum2/@count
calc rmsdif = sqrt(@avediff2 -(@avediff*@avediff))  
!AAE; average absolute error
calc aae = @asum/@count

echo avediff, rmsdiff, average absolute error
echo @avediff @rmsdif @aae

stop
